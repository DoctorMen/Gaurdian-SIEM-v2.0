<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guardian SIEM v2.0 ‚Äî Mission Control</title>
    <link rel="stylesheet" href="/static/css/dashboard.css">
    <!-- Leaflet.js for GeoIP Map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
</head>
<body>

<!-- ============ Top Navigation ============ -->
<nav class="navbar">
    <div class="navbar-brand">
        <span class="shield-icon">üõ°Ô∏è</span>
        Guardian SIEM <span style="font-weight: 400; font-size: 12px; color: var(--text-muted);">v2.0</span>
    </div>
    <div class="navbar-status">
        <div class="status-indicator">
            <span id="status-dot" class="status-dot"></span>
            <span id="status-text">Connecting...</span>
        </div>
        <div class="status-indicator" style="color: var(--text-muted);">
            <span id="clock"></span>
        </div>
    </div>
</nav>

<!-- ============ Dashboard Content ============ -->
<div class="dashboard">

    <!-- ---- Stats Cards ---- -->
    <div class="stats-row">
        <div class="stat-card">
            <div class="label">Total Events</div>
            <div class="value" id="stat-total">‚Äî</div>
            <div class="subtext">All time</div>
        </div>
        <div class="stat-card">
            <div class="label">Last 24 Hours</div>
            <div class="value" id="stat-last24h">‚Äî</div>
            <div class="subtext">Recent activity</div>
        </div>
        <div class="stat-card critical">
            <div class="label">Critical Alerts</div>
            <div class="value" id="stat-critical">‚Äî</div>
            <div class="subtext">Immediate action</div>
        </div>
        <div class="stat-card high">
            <div class="label">High Severity</div>
            <div class="value" id="stat-high">‚Äî</div>
            <div class="subtext">Needs review</div>
        </div>
        <div class="stat-card success">
            <div class="label">Unique IPs</div>
            <div class="value" id="stat-unique-ips">‚Äî</div>
            <div class="subtext">Tracked sources</div>
        </div>
        <div class="stat-card">
            <div class="label">Last Hour</div>
            <div class="value" id="stat-last-hour">‚Äî</div>
            <div class="subtext">Events/hour</div>
        </div>
    </div>

    <!-- ---- Main Content: Events + Sidebar ---- -->
    <div class="content-grid">

        <!-- Left: Live Events Feed -->
        <div class="panel">
            <div class="panel-header">
                <span class="panel-title">üî¥ Live Event Feed</span>
                <div class="filter-bar">
                    <button class="filter-btn active" data-filter="ALL" onclick="setFilter('ALL')">All</button>
                    <button class="filter-btn" data-filter="CRITICAL" onclick="setFilter('CRITICAL')">Critical</button>
                    <button class="filter-btn" data-filter="HIGH" onclick="setFilter('HIGH')">High</button>
                    <button class="filter-btn" data-filter="WARNING" onclick="setFilter('WARNING')">Warning</button>
                    <button class="filter-btn" data-filter="MEDIUM" onclick="setFilter('MEDIUM')">Medium</button>
                    <button class="filter-btn" data-filter="INFO" onclick="setFilter('INFO')">Info</button>
                </div>
            </div>
            <div class="panel-body" id="events-feed" style="max-height: 600px;">
                <div style="text-align: center; padding: 40px; color: var(--text-muted);">
                    <div class="spinner"></div>
                    <div style="margin-top: 10px;">Loading events...</div>
                </div>
            </div>
        </div>

        <!-- Right Sidebar -->
        <div style="display: flex; flex-direction: column; gap: 20px;">

            <!-- Severity Distribution -->
            <div class="panel">
                <div class="panel-header">
                    <span class="panel-title">üìä Severity Distribution</span>
                </div>
                <div class="panel-body" id="severity-chart">
                    <div style="color: var(--text-muted);">Loading...</div>
                </div>
            </div>

            <!-- Top Sources -->
            <div class="panel">
                <div class="panel-header">
                    <span class="panel-title">üì° Top Sources</span>
                </div>
                <div class="panel-body" id="sources-list">
                    <div style="color: var(--text-muted);">Loading...</div>
                </div>
            </div>

        </div>
    </div>

    <!-- ---- GeoIP Map + MITRE Heatmap Row ---- -->
    <div class="bottom-grid">

        <!-- GeoIP Attack Map -->
        <div class="panel">
            <div class="panel-header">
                <span class="panel-title">üåç Attack Origin Map</span>
            </div>
            <div class="panel-body" style="padding: 0;">
                <div id="geomap"></div>
            </div>
        </div>

        <!-- MITRE ATT&CK Heatmap -->
        <div class="panel">
            <div class="panel-header">
                <span class="panel-title">‚öîÔ∏è MITRE ATT&CK Coverage</span>
            </div>
            <div class="panel-body">
                <div class="mitre-grid" id="mitre-heatmap">
                    <div style="color: var(--text-muted);">Loading MITRE data...</div>
                </div>
            </div>
        </div>

    </div>

    <!-- ---- Detection Rules Table ---- -->
    <div class="panel" style="margin-top: 20px;">
        <div class="panel-header">
            <span class="panel-title">üìã Active Detection Rules</span>
            <span style="font-size: 12px; color: var(--text-muted);">Loaded from config/alert_rules.yaml</span>
        </div>
        <div class="panel-body">
            <table class="rules-table">
                <thead>
                    <tr>
                        <th>Severity</th>
                        <th>Rule Name</th>
                        <th>MITRE ID</th>
                        <th>Description</th>
                    </tr>
                </thead>
                <tbody id="rules-table-body">
                    <tr><td colspan="4" style="color: var(--text-muted);">Loading rules...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

</div>

<!-- ============ Scripts ============ -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="/static/js/dashboard.js"></script>
<script>
    // ---- Clock ----
    function updateClock() {
        const el = document.getElementById("clock");
        if (el) el.textContent = new Date().toLocaleTimeString();
    }
    setInterval(updateClock, 1000);
    updateClock();

    // ---- Leaflet GeoIP Map ----
    document.addEventListener("DOMContentLoaded", () => {
        const map = L.map("geomap", {
            center: [20, 0],
            zoom: 2,
            zoomControl: false,
            attributionControl: false,
        });

        L.tileLayer("https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png", {
            maxZoom: 18,
        }).addTo(map);

        // Fetch and plot GeoIP data
        async function loadGeoData() {
            try {
                const resp = await fetch("/api/geo");
                const data = await resp.json();
                data.forEach(point => {
                    if (point.latitude && point.longitude && point.latitude !== 0) {
                        const color = point.threat_score > 50 ? "#ef4444" :
                                      point.threat_score > 20 ? "#f59e0b" : "#3b82f6";
                        L.circleMarker([point.latitude, point.longitude], {
                            radius: Math.min(Math.max(point.count || 3, 3), 15),
                            fillColor: color,
                            color: color,
                            weight: 1,
                            opacity: 0.8,
                            fillOpacity: 0.5,
                        }).addTo(map).bindPopup(
                            `<b>${point.ip || "Unknown"}</b><br>` +
                            `${point.city || ""}, ${point.country || "Unknown"}<br>` +
                            `Events: ${point.count || 0}<br>` +
                            `Threat Score: ${point.threat_score || 0}/100`
                        );
                    }
                });
            } catch (e) {
                console.log("GeoIP data not available yet");
            }
        }
        loadGeoData();
        setInterval(loadGeoData, 30000);
    });
</script>

</body>
</html>
